# Фреймворк Spring (семинары)  
## Урок 12.  
### Задание: 
На базе первого примера разобранного на семинаре, добавить в один из проектов разработанных ранее spring Integration.  
Сохранять запросы от пользователя в файл.  
Добавить в проект один из паттернов разобранных на лекции.   

 
## Выполнение:
Spring integration добавлен в сервис store_resource_server.  
При оплате товара направляется сообщение (записывается в файл с наименованием товара) о дате и времени продажи товара,  
его количестве и стоимости, а также дате когда данный товар был зарезервирован.
IntegrationConfig - пакет configuration.  
FileGateway -  пакет service.integration.
Реализация в методе basketPay() класса CharacterApiServiceImpl - пакет service.api  
Файлы сохраняются в папке messages.  

В сервис store_resource_server также добавлен паттерн Observer.  
При поступлении нового товара в продажу всем подписчикам направляется уведомление.  
Уведомление реализовано через ранее добавленный integration в виде записи в файл с именем пользователя.  
NewProductListener - в пакете service.observer.  
NewProductEvent - в пакете model.observer.   
Метод notifyUser в классе IntegrationConfig - пакет configuration. 
Метод saveOneCardById в классе ServerDbServiceImpl.  


# Краткое описание проекта.  

## Внимание: 
Для простоты проверки и для того, чтобы не переносить базу данных Postgres, временно работа проводится с Н2. 
Сервис конфигурации запускается первым. Файл конфигурации подгружается с гитхаб.  
В коде созданы два пользователя admin и user с паролями admin и user соответственно.  
После запуска всех сервисов предлагается следующий порядок:  
- Зайти на страницу localhost:8082/storage и авторизоваться.  
- Закупить товар на склад - клики на карточки.  
- В меню выбрать склад и выставить товар на продажу - клики на карточки.  
- Выставленный на продажу товар можно посмотреть в меню sale.  
- Зайти на страницу localhost:8081/bank и авторизоваться.
- Выбрать посетителей - клики на карточки.
- Перейти в меню кандидаты и зачислить не менее двух кандидатов в клиенты банка.
- Важно: Первый клиент будет являться продавцом, владельцем магазина, второй клиент покупатель.
- Зайти на страницу localhost:8083/storefront и авторизоваться.  
- Выбрать товар для покупки - клики на карточки.
- Посмотреть корзину выбором соответствующего меню.
- При выборе меню Оплата проводится транзакция.
- Баланс счетов можно посмотреть в банке.



## Микросервисы:
- store_resource_server - Сервер ресурсов магазина;  
- store_warehouse - Веб-сервис склада магазина;  
- storefront - Веб-сервис витрины магазина / торгового зала;  
- bank_resource_server - Сервер ресурсов банка;  
- bank - Веб-сервис банка.  

  1. Сервер ресурсов магазина - StoreServerApp.  

     Порт: 8084  
     База данных: PostgreSQL  - Временно переведена в H2  
     Html страницы:  
     - purchase.html - закупка товара у поставщика - Rick and Morty .  
     - storage.html - товары закупленные на склад, но не выставленные на продажу.  
     - sale.html - товары выставленные на продажу (количество и цена на данном этапе зашиты в код)  
     Веб-контроллер: Нет.

     REST - контроллер.
      1. /store_server/characters/page/{page} - Запрос списка товаров с рессурса поставщика - Rick and Morty.  
          2. /store_server/characters/add_to_storage/{id} - Добавить единицу товара на склад - закупить у поставщика.  
          3. /store_server/characters/delete_from_storage/{id} - Удалить единицу товара со склада. 
          4. /store_server/storage/page/{page} - Получить страницу из списка товаров, хранящихся на складе. 
          5. /store_server/storage/add_to_sale/{id} - Переместить единицу товара со склада на полку продаж.  
         6. /store_server/storage/delete_from_sale/{id} - Удалить товар из списка продаж - убрать с витрины.  
         7. /store_server/sale/page/{page} - Получить страницу из списка товаров, выставленных на продажу.  
         8. /store_server/basket/add_to_basket/{id} - Добавить товар в корзину.  
         9. /store_server/basket/page/{page} - Получить список товаров в корзине.
         10. /store_server/basket/return_to_sale/{id} - Возврат товара из корзины на полку.  
         11. /store_server/basket/pay - Оплата товара из корзины покупателя.  
         12. /store_server/user/{name} - Поиск пользователя по имени.
         13. /store_server/auth/register - Регистрация нового пользователя.  
         14. /store_server/auth/authenticate - 


  2. Склад магазина - WareHouseApp.  
  
      Порт: 8082  
      База данных: нет 
      Html страницы:  
          - purchase.html - закупка товара у поставщика - Rick and Morty.  
          - storage.html - товары закупленные на склад, но не выставленные на продажу.  
          - sale.html - товары выставленные на продажу (количество и цена на данном этапе зашиты в код)  
            - index.html - домашняя страница  
            - message.html - страница сообщений.  
      Веб-контроллер:  
     1. /storage/ - переадресует на страницу /storage/characters/page/1  
      На данной странице загружаются карточки персонажей с адреса https://rickandmortyapi.com/api/character/?page=1  
      Будем считать, что сервис https://rickandmortyapi.com является поставщиком товара -
        в данном случае карточки героев мультфильма.  
      Карточки товара/персонажей можно загружать с сервиса rickandmortyapi.com постранично.  
      При выборе товара / клике на карточку товар загружается в базу данных склада (/storage/characters/add_to_storage/{id}/{page}). 
     2. storage/storage/page/{page} - просмотр товаров, находящихся в базе данных склада.  
        При выборе товара / клике на карточку товар выставляется на продажу  
        - загружается в базу данных товаров на витрине (storage/storage/add_to_sale/{id}/{page}).   
     3. storage/sale/page/{page} - просмотр товаров выставленных на продажу.  
       
     REST - контроллер.  
     нет
        
2. Витрина магазина / торговый зал - StorefrontApp  
   Порт: 8083  
   База данных: нет  
   Html страницы:  
    - purchase.html - товар на витрине магазина, выставленный на продажу.  
    - basket.html - товар в корзине покупателя.  
      - index.html - домашняя страница  
      - message.html - страница сообщений.  
    
         Веб-контроллер:  
         1. /storefront - переадресует на страницу /storefront/cards/page/1.  
            На данной странице отображается товар, выставленный на продажу и загружаемый с сервиса склада магазина.  
            При выборе товара / клике на карточку товар загружается в корзину /storefront/basket/add_to_basket/{id}/{page}  
            При этом, номер товара передается в сервис склада магазина 
             для его резервирования в базе данных корзины покупателей.  
            2. /storefront/basket/page/{page} - просмотр товаров в корзине.  
               При выборе товара / клике на карточку товар возвращается на полку (/storefront/basket/delete_from_basket/{id}/{page}).  
            При этом, номер товара передается сервису склада магазина для перемещения товара между базами данных.  
            3. /storefront/basket/pay - оплата товара в корзине. Передает информацию сервису склада для запуска процесса оплаты.  

3. Сервер ресурсов банка - BankServerApp  
   Порт: 8085  
   База данных: PostgreSQL  - временно H2  
   Html страницы:  
    Нет.   

   Веб-контроллер:  
    Нет.  

   REST - контроллер.
    1. /bank_server/visitors/page/{page} - Запрос списка "посетителей банка" 
      в тестовом варианте страницы из списка персонажей с ресурса Rick and Morty.  
    2. /bank_server/visitors/add_to_bank/{id} - Добавить посетителя банка в базу данных кандидатов на открытие счета.  
   3. /bank_server/candidates/delete_from_bank/{id} - Удалить кандидата на открытие счета из базы данных.
   4. /bank_server/candidates/page/{page} - Получить список кандидатов на открытие счета.  
   5. /bank_server/candidates/add_to_client/{id} - Добавить кандидата в базу данных клиентов банка - открыть счет.
   6. /bank_server/clients/delete_client/{id} - Удаление клиента из базы данных банка - закрыть счет.  
   7. /bank_server/clients/page/{page} - Получить список клиентов банка.
   8. /bank_server/clients/update - Обновить данные о клиенте банка.
   9. /bank_server/transaction - Проведение транзакции.
   10. /bank_server/user/{name} -Поиск пользователя по имени.  
   11. /bank_server/auth/register - Регистрация нового пользователя.  
   12. /bank_server/auth/authenticate - Аутентификация пользователя.

4. Банк - BankApp  
   Порт: 8081  
   База данных: нет  
   Html страницы:  
   - visitors.html - посетители банка, желающие открыть счет.  
    Для эмуляции посетителей их карточки загружаются с сервиса https://rickandmortyapi.com по аналогии со складом магазина.  
   - candidates.html - отобранные кандидаты на открытие счета.  
   - clients.html - клиенты банка.  

   Веб-контроллер:  
    1. /bank - переадресует на страницу /bank/visitors/page/1.  
       На данной странице загружаются карточки персонажей с адреса https://rickandmortyapi.com/api/character/?page=1   
       Будем считать, что данные персонажи являются посетителями банака и желают открыть счет.  
       Посетителей банка/персонажей можно загружать с сервиса rickandmortyapi.com постранично.  
       При выборе посетителя / клике на карточку данный посетитель переводится в разряд кандидатов
        и загружается в базу данных банка (/bank/visitors/add_to_bank/{id}/{page}).  
       Кандидаты отображаются На этой же странице ниже.  
       При выборе кандидата / клике на карточку в данной области кандидат удаляется из базы данных
       (/bank/candidates/delete_from_bank/{id}/{page}).  
    2. /bank/candidates/page/{page} - просмотр кандидатов, находящихся в базе данных банка.  
       При выборе кандидата / клике на карточку кандидат переводится в статус клиента  
        - загружается в базу данных клиентов банка (/bank/candidates/add_to_client/{id}/{page}).  
          Клиенты отображается на этой же странице ниже.  
          При выборе клиента / клике на карточку в данной области клиент удаляется из базы данных. 
          (/bank/clients/delete_client/{id}/{page}).
    3. /bank/clients/page/{page} - просмотр клиентов банка.  


## Внимание: На стадии разработки сервиса транзакия осуществляется между счетами 1 - продавец и 2 - покупатель.    
